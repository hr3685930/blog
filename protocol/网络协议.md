# 网络协议


![](%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/5EB46355-CCA7-4D73-8C0F-651AFD3E1EB1.png)

网络为什么要分层？
复杂的程序都要分层，这是程序设计的要求。

只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层

对 TCP 协议来说，三次握手也好，重试也好，只要想发出去包，就要有 IP 层和MAC 层，不然是发不出去的。

IP 是地址，有定位功能；MAC 是身份证，无定位功能；
CIDR 可以用来判断是不是本地人；

![](%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/71E31691-0694-4782-B6A6-0618B3C1110A.png)
Wi-Fi 路由器的地址就是 192.168.0.1，而 192.168.0.255 就是广播地址。

MAC 地址的通信范围比较小，局限在一个子网里面。例如，从 192.168.0.2/24 访问 192.168.0.3/24 是可以用 MAC 地址的。一旦跨子网，即从 192.168.0.2/24 到192.168.1.2/24，MAC 地址就不行了，需要 IP 地址起作用了

## IP
IP 头里面包含源 IP 地址和目标 IP 地址，这两种 IP 地址都可以转换成其他地
址。转换源 IP 地址的，我们称为 Snat；转换目标 IP 地址的，我们称为Dnat。


## CIDR
10.100.122.2/24，这个 IP 地址中有一个斜杠，斜杠后面有个数字 24。这种地址表示形式，就是 CIDR
后面 24 的意思是，32 位中，前 24位是网络号，后 8 位是主机号。
伴随着 CIDR 存在的，一个是广播地址，10.100.122.255。如果发送这个地址，所有10.100.122 网络里面的机器都可以收到。另一个是
子网掩码，255.255.255.0。
将子网掩码和 IP 地址进行 AND 计算。前面三个 255，转成二进制都是 1。1 和任何数值取 AND，都是原来数值，因而前三个数不变，为 10.100.122。后面一个 0，转换成二进制是 0，0 和任何数值取 AND，都是 0，因而最后一个数变为 0，合起来就是10.100.122.0。这就是
网络号。


## DHCP
DHCP 协议主要是用来给客户租用 IP 地址，和房产中介很像，要商谈、签约、续租，广播还不能“抢单”；
DHCP 协议能给客户推荐“装修队”PXE，能够安装操作系统，这个在云计算领域大有用处。

### 物理层

### 数据链路层
ARP 协议
也就是已知 IP 地址，求 MAC 地址的协议。
MAC 层是用来解决多路访问的堵车问题的
ARP 是通过吼的方式来寻找目标 MAC 地址的，吼完之后记住一段时间，这个叫作缓存
交换机是有 MAC 地址学习能力的，学完了它就知道谁在哪儿了，不用广播了

当交换机的数目越来越多的时候，会遭遇环路问题，让网络包迷路，这就需要使用 STP协议，通过华山论剑比武的方式，将有环路的图变成没有环路的树，从而解决环路问题。
交换机数目多会面临隔离问题，可以通过 VLAN 形成虚拟局域网，从而解决广播问题和安全问题。


常用的ping 就是查询报文，是一种主动请求，并且获得主动应答的 ICMP 协议
不改变 IP 地址的网关，我们称为转发网关；
改变 IP 地址的网关，我们称为NAT 网关。
路由器是一个三层设备，里面有如何寻找下一跳的规则；


### 动态路由协议
基于链路状态路由算法的OSPF

基于距离矢量路由算法的BGP

BGP 又分为两类，eBGP 和 iBGP。
自治系统间，边界路由器之间使用 eBGP 广播路由。
内部网络也需要访问其他的自治系统。边界路由器如何将 BGP 学习到的路由导入到内部网络呢？就是通过运行 iBGP


路由分静态路由和动态路由，静态路由可以配置复杂的策略路由，控制转发策略；
动态路由主流算法有两种，距离矢量算法和链路状态算法。基于两种算法产生两种协议，
BGP 协议和 OSPF 协议。

## TCP
TCP 包头很复杂，但是主要关注五个问题，顺序问题，丢包问题，连接维护，流量控制，拥塞控制；
连接的建立是经过三次握手，断开的时候四次挥手


## Socket
经常考的知识点，就是监听的 Socket 和真正用来传数据的 Socket 是两个，一个叫作监听 Socket，一个叫作已连接 Socket。


## HTTP
HTTP 2.0 通过头压缩、分帧、二进制编码、多路复用等技术提升性能；
QUIC 协议通过基于 UDP 自定义的类似 TCP 的连接、重试、多路复用、流量控制技术，进一步提升性能。

## P2P
下载一个文件可以使用 HTTP 或 FTP，这两种都是集中下载的方式，而 P2P 则换了一种思路，采取非中心化下载的方式；


## DNS
![](%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/29411748-DF90-4FB8-8056-57A095B37E57.png)

* 传统的DNS有解析慢，更新不及时，转发跨运营商，nat跨运营商等问题，影响了流量的调度。
* HTTPDNS通过客户端sdk和服务端，直接解析dns，绕过了传统dns缺点，实现智能调度。


## CDN
CDN 支持流媒体协议
CDN 和电商系统的分布式仓储系统一样，分为中心节点、区域节点、边缘节点，而数据缓存在离用户最近的位置。

CDN最擅长的是缓存静态数据，还可以缓存流媒体数据


## 数据中心
![](%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/5721EF48-DF1F-419C-8B78-0BD03801E466.png)

这是一个典型的三层网络结构。这里的三层不是指 IP 层，而是指接入层、汇聚层、核心层 三层。
数据中心的所有链路都需要高可用性。服务器需要绑定网卡，交换机需要堆叠，三层设备可以通过等价路由，二层设备可以通过 TRILL 协议。

## VPN
VPN 可以将一个机构的多个数据中心通过隧道的方式连接起来，让机构感觉在一个数据中心里面
完全基于软件的 IPsec VPN 可以保证私密性、完整性、真实性、简单便宜，但是性能稍微差一些
MPLS-VPN 综合和 IP 转发模式和 ATM 的标签转发模式的优势，性能较好，但是需要从运营商购买


## 云计算网络
云计算的关键技术是虚拟化，这里我们重点关注的是，虚拟网卡通过打开 TUN/TAP 字符设备的方式，将虚拟机内外连接起来；
云中的网络重点关注四个方面，共享、隔离、互通、灵活。其中共享和互通有两种常用的方式，分别是桥接和 NAT，隔离可以通过 VLAN 的方式。
用 SDN 控制整个云里面的网络，就像小区保安从总控室管理整个物业是一样的，将控制面和数据面进行了分离；
一种开源的虚拟交换机的实现 OpenvSwitch，它能对经过自己的包做任意修改，从而使得云对网络的控制十分灵活；将 OpenvSwitch 引入了云之后，可以使得配置简单而灵活，并且可以解耦物理网络和虚拟网络。

你家里访问 163 网站的时候，在你路由器的出口，会做 Snat 的，运营商的出
口也可能做 Snat，将你的私网 IP 地址，最终转换为公网 IP 地址，然后 163 网站就可以通过这个公网 IP 地址返回结果，然后再 nat 回来，直到到达你的笔记本电脑。

iptables 还可以通过 QUEUE 实现负载均衡 ,iptables 有一个probability特性，可以设置Probability的百分比是多少，从而实现负载均衡

要对不同用户的网络进行隔离，解决 VLAN 数目有限的问题，需要通过 Overlay 的方式，常用的有 GRE 和 VXLAN。
GRE 是一种点对点的隧道模式，VXLAN 支持组播的隧道模式，它们都要在某个 Tunnel Endpoint 进行封装和解封装，来实现跨物理机的互通。
OpenvSwitch 可以作为 Tunnel Endpoint，通过设置流表的规则，将虚拟机网络和物理机网络进行隔离、转换。

## 容器网络
Docker 有两种方式，一种是通过一个进程
docker-proxy的方式，监听 10080，转换为80 端口。

另外一种方式是通过DNAT方式，在 -A PREROUTING 阶段加一个规则，将到端口 10080的 DNAT 称为容器的私有网络。

Calico 推荐使用物理机作为路由器的模式，这种模式没有虚拟化开销，性能比较高。
Calico 的主要组件包括路由、iptables 的配置组件 Felix、路由广播组件 BGP
Speaker，以及大规模场景下的 BGP Route Reflector。
为解决跨网段的问题，Calico 还有一种 IPIP 模式，也即通过打隧道的方式，从隧道端点来看，将本来不是邻居的两台机器，变成相邻的机器


GRPC 是一种二进制，性能好，跨语言，还灵活，同时可以进行服务治理的多快好省的RPC 框架，唯一不足就是还是要写协议文件。
GRPC 序列化使用 Protocol Buffers，网络传输使用 HTTP 2.0，服务治理可以使用基于Envoy 的 Service Mesh。
